package common.utils.http;

import common.utils.http.DeviceInfo;
import jakarta.servlet.http.HttpServletRequest;
import ua_parser.Client;
import ua_parser.Parser;
import org.lionsoul.ip2region.xdb.Searcher;
import java.io.File;
import java.net.InetAddress;
import java.net.URL;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

public class DeviceInfoUtils {

    private static final Parser UA_PARSER = new Parser();
    private static Searcher SEARCHER;

    static {
        try {
            // 你的 ip2region.xdb 文件路径（放在 resources/ip2region.xdb）
            String dbPath = new File(DeviceInfoUtils.class.getClassLoader().getResource("ip2region.xdb").toURI()).getPath();
            SEARCHER = Searcher.newWithFileOnly(dbPath);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static DeviceInfo getDeviceInfo(HttpServletRequest request) {
        DeviceInfo info = new DeviceInfo();
        String ua = request.getHeader("User-Agent");
        String ip = getClientIp(request);

        info.setIp(ip);
        info.setUserAgent(ua);

        try {
            Client client = UA_PARSER.parse(ua);
            info.setOs(client.os.family);
            info.setBrowser(client.userAgent.family);
            info.setDevice(client.device.family);
        } catch (Exception e) {
            info.setDevice("Unknown");
        }

        // 获取 IP 地理信息
        try {
            String region = SEARCHER.search(ip);
            info.setRegion(region); // 格式如：中国|广东省|深圳市|电信|5G
        } catch (Exception e) {
            info.setRegion("unknown");
        }

        // 获取公网增强信息（品牌、网络类型）
        try {
            String apiUrl = "http://ip-api.com/json/" + URLEncoder.encode(ip, StandardCharsets.UTF_8)
                    + "?fields=status,country,regionName,city,isp,org,mobile,proxy";
            String json = new String(new URL(apiUrl).openStream().readAllBytes(), StandardCharsets.UTF_8);
            info.setNetworkInfo(json);
        } catch (Exception e) {
            info.setNetworkInfo("N/A");
        }

        return info;
    }

    // 从 request 中解析 IP
    private static String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isBlank() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}
