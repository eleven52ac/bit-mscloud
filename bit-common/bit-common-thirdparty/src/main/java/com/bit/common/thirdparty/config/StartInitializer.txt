package commons.config;

import cn.hutool.crypto.SecureUtil;
import cn.hutool.crypto.symmetric.AES;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.bit.api.service.IdPrefixRegionApiService;
import jakarta.annotation.PostConstruct;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import commons.constant.security.SaltConstants;
import commons.utils.IdCardUtil;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.*;
import java.util.stream.Collectors;

@Slf4j
@Component
public class StartInitializer {

    @Autowired
    private IdPrefixRegionApiService idPrefixRegionApiService;

    @Autowired
    private IdPrefixRegionService idPrefixRegionService;

    @Autowired
    private PersonInfoService personInfoService;

    @Autowired
    private PersonsInfoService personsInfoService;

    private final BlockingDeque<Runnable> taskQueue = new LinkedBlockingDeque<>();




    /**
     * 所有预加载，自动执行任务
     */
    @PostConstruct
    private void uniteInit() {
        // 初始化任务队列，先执行基础任务，再执行依赖任务
        taskQueue.add(this::districtCodesMapInit); // 必须第一个执行
        //taskQueue.add(this::syncData);             // 依赖第一个任务
        ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();
        log.error("\u001B[42m\u001B[30m《 所有预加载，自动执行任务开始！》\u001B[0m");

        try {
            // 异步执行主任务流程
            CompletableFuture<String> preloadFuture = CompletableFuture.supplyAsync(() -> {
                // 先执行第一个任务（同步执行，保证依赖顺序）
                Runnable task = taskQueue.poll();
                if (task != null) task.run();

                // 后续任务异步并发执行
                List<Future<?>> futures = new ArrayList<>();
                while ((task = taskQueue.poll()) != null) {
                    futures.add(executor.submit(task));
                }

                // 等待所有异步任务完成
                for (Future<?> future : futures) {
                    try {
                        future.get();
                    } catch (Exception e) {
                        log.error("异步任务执行异常", e);
                    }
                }

                log.warn("\u001B[41m\u001B[37m《 所有预加载，自动执行任务完成！》\u001B[0m");
                return "SUCCESS";
            }, executor);

            // 任务成功后回调
            preloadFuture.thenAccept(result -> {
                log.warn("\u001B[44m\u001B[37m《数据同步结果: {}》\u001B[0m", result);
                executor.shutdown();
            });

            // 异常回调（注意不能用 exceptionallyAsync）
            preloadFuture.exceptionally(throwable -> {
                log.error("预加载流程异常", throwable);
                return "FAILED";
            });
        } catch (Exception e) {
            log.error("预加载主流程捕获异常", e);
            executor.shutdown();
        }
    }



    /**
     * 初始化身份证对应行政区域缓存
     */
    private void districtCodesMapInit() {
        idPrefixRegionService.list().forEach(item -> {
            IdCardUtil.DISTRICT.put(item.getIdPrefix(), item.getRegionName());
        });
        log.warn("\u001B[46m\u001B[30m ---- 身份证对应行政区域缓存初始化完毕！--- \u001B[0m");
    }


    private void syncData() {
        long count = personsInfoService.getDataCount();
        log.info("当前数据量：{}", count);
        if (count == 0) return;
        int pageSize = 1000;
        int totalPages = (int) Math.ceil((double) count / pageSize);
        try (ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor()) {
            List<Future<?>> futures = new ArrayList<>();
            for (int i = 1; i <= totalPages; i++) {
                final int pageIndex = i;
                futures.add(executor.submit(() -> {
                    log.info("当前进度：{}", pageIndex);
                    List<PersonsInfo> list = personsInfoService.list(new Page<>(pageIndex, pageSize));
                    List<PersonInfo> persons = list.stream().map(item -> {
                        PersonInfo personInfo = new PersonInfo();
                        personInfo.setId(item.getPersonId());
                        personInfo.setName(item.getPersonName());
                        personInfo.setAge(IdCardUtil.getAge(item.getCardNumber()));
                        personInfo.setBirthday(IdCardUtil.getBirthday(item.getCardNumber()));
                        personInfo.setGender(IdCardUtil.getGender(item.getCardNumber()));
                        personInfo.setRegister(IdCardUtil.getAddress(item.getCardNumber()));
                        byte[] key = SaltConstants.SALT_KEY_1.getBytes();
                        AES aes = SecureUtil.aes(key);
                        String encryptHex = aes.encryptHex(item.getCardNumber() != null ? item.getCardNumber() : "");
                        personInfo.setIdCard(encryptHex);
                        return personInfo;
                    }).collect(Collectors.toList());
                    personInfoService.saveOrUpdateBatch(persons);
                }));
            }
            // 等待所有任务完成
            for (Future<?> future : futures) {
                try {
                    future.get();
                } catch (Exception e) {
                    log.error("分页处理任务失败", e);
                }
            }
        } catch (Exception e) {
            log.error("线程池执行异常", e);
        }
        log.info("全部数据处理完成，数据量：{}", count);

    }



}
