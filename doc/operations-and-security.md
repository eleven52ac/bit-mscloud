# 运维与安全

## 1. 日志与审计
- **日志归档**：默认输出到 `logs/` 目录（`application.log`、`access.log` 等），建议引入 logback 异步+分日滚动。
- **链路标识**：可在网关添加 `traceId` 头，并通过 MDC 贯穿各服务，方便定位跨服务请求。
- **敏感脱敏**：在登录、注册日志中屏蔽明文密码、验证码；`PersonsInfoServiceImpl` 已对身份信息脱敏，可扩展统一工具。
- **审计事件**：`UserLoginEventListener` 产出的“异地登录”日志建议投递至告警平台（钉钉/飞书/短信），并保留审计记录。

## 2. 监控与告警
- **基础监控**：CPU、内存、磁盘、线程、堆指标，可通过 Prometheus + Micrometer 实现。
- **业务指标**：
  - 登录成功/失败次数、Redis 登录计数键数量。
  - 验证码发送成功率、短信/邮件通道延迟。
  - ES 索引大小、查询时延、批量写入 TPS。
  - 缓存命中率（Redis、本地）、旁路更新耗时。
- **告警阈值示例**：
  - 5 分钟内登录失败率 > 10%；
  - Redis QPS > 阈值或延迟 > 20ms；
  - ES 节点磁盘利用率 > 80%；
  - `UserLoginEvent` 连续触发异地登录 > N 次。

## 3. 安全防护

### 3.1 鉴权与 Token
- 目前登录生成的 JWT 使用 `JWTSignerUtil.none()`（无签名），仅适合示例。生产需：
  - 改为非对称加密或至少 HMAC；
  - 在网关或服务端验证签名；
  - 将 token 与 Redis 中的会话绑定与过期同步。
- 引入刷新 token 机制，用于长连接场景。

### 3.2 内部调用
- `X-Internal-Token` 作为服务间凭证，应由网关签发并注入，服务端校验有效性（可放入 Redis 或 JWT 中）。
- 重要接口（如登录历史写入）可结合 `@CheckLogin` 或自定义 `@CheckInternal`。

### 3.3 数据安全
- **敏感字段**：手机号、身份证、银行卡等字段在表中可加密存储（列级加密或 KMS）。
- **传输层**：启用 HTTPS/mTLS，`bit-gateway` 与 `bit-auth` 已提供 keystore/truststore 示例。
- **最小权限**：数据库账号拆分读写；Redis 赋予特定库；Elasticsearch 采用角色控制。

### 3.4 入侵防护
- 登录接口已实现防暴力破解（Redis 计数器 + 锁定 1 小时），需要配合 IP 黑名单/限流。
- 对所有输入做白名单或长度、格式校验（用户名、邮箱、验证码等已实现）。
- 启用网关 WAF/限流组件（如 Sentinel、Resilience4j）。

## 4. 备份与恢复
- **数据库**：每日全量备份 + 每小时增量；`user_login_history` 可只保留半年并归档。
- **Redis**：启用 AOF + RDB，或采用 Redis Cluster + 哨兵。
- **Elasticsearch**：使用快照（Snapshot）备份索引数据，存储到对象存储。
- **配置与凭证**：集中存储在配置中心与 Secret 管理中，定期导出加密备份。

## 5. 变更管理
- 配置变更需走审批，记录变更人、时间、内容。
- 代码上线需附带：
  - 变更描述
  - 回滚方案
  - 测试报告/截图
  - 影响范围评估

## 6. 合规建议
- 对日志、审计数据进行访问控制，保证不可被未授权人员查看。
- 收集用户信息需满足数据合规要求，可配置数据脱敏/匿名化策略。
- 若系统涉及跨境传输，需评估当地法规并采取合适的数据驻留策略。

## 7. TODO / 下一步
1. 引入统一的配置中心管理敏感信息，清理仓库中的明文凭证。
2. 网关增加鉴权、限流、熔断、Metrics 收集 Filter。
3. 接入统一监控平台（Prometheus + Grafana + Loki）或 APM。
4. 对 `UserLoginEvent` 添加消息队列（如 Kafka/RabbitMQ），实现异步可观测链路。
5. 对接 CI/CD 后，将安全扫描、依赖漏洞扫描纳入流水线。

> 运维与安全工作是持续过程，建议把以上措施纳入 SRE backlog，并定期复盘突发事件与告警，持续优化。

